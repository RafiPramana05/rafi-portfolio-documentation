name: Convert Markdown to PDF

on:
  push:
    branches: [ main, master ]
  workflow_dispatch: # Manual trigger

permissions:
  contents: write

jobs:
  convert-to-pdf:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Cache LaTeX packages
      uses: actions/cache@v4
      with:
        path: |
          /usr/share/texlive
          /usr/local/texlive
        key: latex-packages-${{ runner.os }}-v2
        restore-keys: |
          latex-packages-${{ runner.os }}-
          
    - name: Setup Pandoc
      uses: r-lib/actions/setup-pandoc@v2
      with:
        pandoc-version: '3.1.8'
        
    - name: Install LaTeX with XeLaTeX (Optimized)
      run: |
        # Only install if not cached
        if ! command -v xelatex &> /dev/null; then
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends texlive-latex-base texlive-fonts-recommended texlive-xetex texlive-latex-extra
          sudo apt-get install -y --no-install-recommends fonts-dejavu-core
        fi
        
    - name: Create Simplified CSS
      run: |
        echo "/* Minimal CSS - LaTeX handles most styling */" > simple-style.css
        
    - name: Create LaTeX Header for Code Blocks
      run: |
        cat > latex-header.tex << 'EOF'
        % LaTeX packages for better code handling - ORDER MATTERS!
        \usepackage{xcolor}
        \usepackage{fancyvrb}
        \usepackage{listings}
        \usepackage{fvextra}
        
        % Define colors first
        \definecolor{codebackground}{RGB}{30, 30, 30}
        \definecolor{codetext}{RGB}{212, 212, 212}
        \definecolor{keywordcolor}{RGB}{197, 134, 192}
        \definecolor{stringcolor}{RGB}{206, 145, 120}
        \definecolor{commentcolor}{RGB}{106, 153, 85}
        
        % Configure fancyvrb for better code blocks
        \fvset{
          breaklines=true,
          breakanywhere=true,
          fontsize=\small,
          frame=single,
          framesep=3mm,
          rulecolor=\color{gray}
        }
        
        % Configure listings for syntax highlighting
        \lstset{
          basicstyle=\ttfamily\small\color{codetext},
          backgroundcolor=\color{codebackground},
          frame=single,
          framesep=3mm,
          rulecolor=\color{gray},
          breaklines=true,
          breakatwhitespace=true,
          showstringspaces=false,
          keywordstyle=\color{keywordcolor}\bfseries,
          commentstyle=\color{commentcolor}\itshape,
          stringstyle=\color{stringcolor}
        }
        
        % Override Pandoc's default Shaded environment for code blocks
        \DefineVerbatimEnvironment{Highlighting}{Verbatim}{
          breaklines=true,
          breakanywhere=true,
          fontsize=\small,
          frame=single,
          framesep=3mm,
          rulecolor=\color{gray}
        }
        EOF
        
    - name: Prepare Markdown for PDF (Replace Emoji)
      run: |
        # Create a copy of markdown with emoji replaced for better PDF compatibility
        sed 's/✅/[CHECKMARK]/g; s/🚀/[ROCKET]/g; s/📄/[DOCUMENT]/g; s/⚡/[LIGHTNING]/g; s/🎯/[TARGET]/g; s/📊/[CHART]/g; s/🔄/[REFRESH]/g; s/✨/[SPARKLES]/g; s/📅/[CALENDAR]/g; s/🎉/[PARTY]/g; s/💡/[BULB]/g; s/🔧/[WRENCH]/g; s/📁/[FOLDER]/g; s/🏷️/[TAG]/g; s/📥/[INBOX]/g; s/📝/[MEMO]/g; s/🎛️/[CONTROL]/g' "DOKUMENTASI_WEBSITE_RAFI_PRAMANA_PUTRA.md" > "DOKUMENTASI_CLEAN.md"
        
    - name: Convert MD to PDF with Styling
      run: |
        # Try XeLaTeX first, fallback to pdflatex if failed
        pandoc "DOKUMENTASI_CLEAN.md" \
          -o "Dokumentasi_Portfolio_Rafi_Pramana_Putra.pdf" \
          --from markdown \
          --to pdf \
          --pdf-engine=xelatex \
          --highlight-style=breezedark \
          --include-in-header=latex-header.tex \
          --toc \
          --toc-depth=3 \
          --number-sections \
          -V geometry:margin=2.5cm \
          -V mainfont="DejaVu Sans" \
          -V monofont="DejaVu Sans Mono" \
          -V fontsize=11pt \
          -V linestretch=1.2 \
          -V papersize=a4 \
          -V documentclass=article \
          --metadata title="Dokumentasi Website Portfolio Rafi Pramana Putra" \
          --metadata author="Rafi Pramana Putra" \
          --metadata date="$(date +'%B %Y')" || \
        # Fallback to pdflatex if xelatex fails
        pandoc "DOKUMENTASI_CLEAN.md" \
          -o "Dokumentasi_Portfolio_Rafi_Pramana_Putra.pdf" \
          --from markdown \
          --to pdf \
          --pdf-engine=pdflatex \
          --highlight-style=breezedark \
          --include-in-header=latex-header.tex \
          --toc \
          --toc-depth=3 \
          --number-sections \
          -V geometry:margin=2.5cm \
          -V fontsize=11pt \
          -V linestretch=1.2 \
          -V papersize=a4 \
          -V documentclass=article \
          --metadata title="Dokumentasi Website Portfolio Rafi Pramana Putra" \
          --metadata author="Rafi Pramana Putra" \
          --metadata date="$(date +'%B %Y')"
          
    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: pdf-v${{ github.run_number }}
        name: "Documentation PDF v${{ github.run_number }}"
        body: |
          📄 **Dokumentasi Portfolio Website - PDF Version**
          
          🚀 **Generated automatically from Markdown**
          
          ✨ **Features:**
          - Professional styling dengan syntax highlighting
          - Background hitam untuk code blocks  
          - Warna ungu untuk keywords
          - Warna oranye kekuningan untuk HTML tags
          - Table of contents dengan numbering
          - Responsive layout untuk print
          
          📅 **Generated on:** $(date +'%Y-%m-%d %H:%M:%S UTC')
          🔄 **Commit:** ${{ github.sha }}
          
        files: |
          Dokumentasi_Portfolio_Rafi_Pramana_Putra.pdf
        draft: false
        prerelease: false
        
    - name: Upload PDF as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: documentation-pdf
        path: Dokumentasi_Portfolio_Rafi_Pramana_Putra.pdf
        retention-days: 90
